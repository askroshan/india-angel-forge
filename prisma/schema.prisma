// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String   @map("password_hash")
  fullName     String?  @map("full_name")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  roles                 UserRole[]
  founderApplications   FounderApplication[]
  investorApplications  InvestorApplication[]
  eventRegistrations    EventRegistration[]
  eventWaitlist         EventWaitlist[]
  companyProfiles       CompanyProfile[]
  pitchSessions         PitchSession[]
  pitchMaterials        PitchMaterial[]
  portfolioCompanies    PortfolioCompany[]
  portfolioUpdates      PortfolioUpdate[]
  sharedDocuments       SharedDocument[]
  deals                 Deal[]
  dueDiligenceItems     DueDiligenceItem[]
  spvs                  Spv[]
  spvMemberships        SpvMember[]
  dealInterests         DealInterest[]
  dealDocuments         DealDocument[]
  investmentCommitments InvestmentCommitment[]
  // New relations
  kycDocuments          KYCDocument[]
  amlScreenings         AMLScreening[]
  accreditations        Accreditation[]
  documents             Document[]
  companies             Company[]              @relation("FounderCompany")
  commitments           Commitment[]
  auditLogs             AuditLog[]
  payments              Payment[]
  paymentMethods        PaymentMethod[]

  @@map("users")
}

model UserRole {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  role      String
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, role])
  @@map("user_roles")
}

model Event {
  id                   String    @id @default(uuid())
  title                String
  description          String?
  eventDate            DateTime  @map("event_date")
  location             String?
  capacity             Int?
  registrationDeadline DateTime? @map("registration_deadline")
  status               String    @default("upcoming")
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")

  registrations EventRegistration[]
  waitlist      EventWaitlist[]

  @@map("events")
}

model EventRegistration {
  id                  String   @id @default(uuid())
  eventId             String   @map("event_id")
  userId              String   @map("user_id")
  fullName            String   @map("full_name")
  email               String
  phone               String?
  company             String?
  dietaryRequirements String?  @map("dietary_requirements")
  status              String   @default("confirmed")
  notes               String?
  reminderSent        Boolean  @default(false) @map("reminder_sent")
  registeredAt        DateTime @default(now()) @map("registered_at")

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@map("event_registrations")
}

model EventWaitlist {
  id         String    @id @default(uuid())
  eventId    String    @map("event_id")
  userId     String    @map("user_id")
  fullName   String    @map("full_name")
  email      String
  phone      String?
  company    String?
  position   Int       @default(1)
  status     String    @default("waiting")
  notifiedAt DateTime? @map("notified_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@map("event_waitlist")
}

model FounderApplication {
  id             String    @id @default(uuid())
  userId         String?   @map("user_id")
  fullName       String    @map("full_name")
  email          String
  phone          String?
  companyName    String    @map("company_name")
  companyWebsite String?   @map("company_website")
  industry       String?
  stage          String?
  description    String?
  fundingGoal    Decimal?  @map("funding_goal") @db.Decimal(15, 2)
  currentRevenue Decimal?  @map("current_revenue") @db.Decimal(15, 2)
  pitchDeckUrl   String?   @map("pitch_deck_url")
  status         String    @default("pending")
  reviewedAt     DateTime? @map("reviewed_at")
  reviewedBy     String?   @map("reviewed_by")
  reviewNotes    String?   @map("review_notes")
  submittedAt    DateTime  @default(now()) @map("submitted_at")

  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("founder_applications")
}

model InvestorApplication {
  id                   String    @id @default(uuid())
  userId               String?   @map("user_id")
  fullName             String    @map("full_name")
  email                String
  phone                String?
  investorType         String    @map("investor_type")
  organization         String?
  investmentRange      String?   @map("investment_range")
  industriesOfInterest String?   @map("industries_of_interest")
  linkedinUrl          String?   @map("linkedin_url")
  accreditationStatus  String?   @map("accreditation_status")
  status               String    @default("pending")
  reviewedAt           DateTime? @map("reviewed_at")
  reviewedBy           String?   @map("reviewed_by")
  reviewNotes          String?   @map("review_notes")
  submittedAt          DateTime  @default(now()) @map("submitted_at")

  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("investor_applications")
}

model CompanyProfile {
  id          String   @id @default(uuid())
  founderId   String   @map("founder_id")
  companyName String   @map("company_name")
  description String
  industry    String?
  stage       String?
  foundedYear Int?     @map("founded_year")
  teamSize    Int?     @map("team_size")
  website     String?
  linkedin    String?
  twitter     String?
  location    String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  founder            User               @relation(fields: [founderId], references: [id], onDelete: Cascade)
  fundraisingRounds  FundraisingRound[]
  portfolioCompanies PortfolioCompany[]

  @@unique([founderId])
  @@map("company_profiles")
}

model FundraisingRound {
  id              String    @id @default(uuid())
  companyId       String    @map("company_id")
  roundName       String    @map("round_name")
  targetAmount    Decimal   @map("target_amount") @db.Decimal(15, 2)
  raisedAmount    Decimal   @default(0) @map("raised_amount") @db.Decimal(15, 2)
  status          String    @default("planning")
  startDate       DateTime? @map("start_date")
  targetCloseDate DateTime? @map("target_close_date")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  company CompanyProfile @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("fundraising_rounds")
}

model PitchSession {
  id          String   @id @default(uuid())
  founderId   String   @map("founder_id")
  investorId  String?  @map("investor_id")
  sessionDate DateTime @map("session_date")
  duration    Int      @default(30)
  location    String?
  meetingLink String?  @map("meeting_link")
  status      String   @default("scheduled")
  notes       String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  founder User @relation(fields: [founderId], references: [id], onDelete: Cascade)

  @@map("pitch_sessions")
}

model PitchMaterial {
  id          String   @id @default(uuid())
  founderId   String   @map("founder_id")
  title       String
  description String?
  fileType    String   @map("file_type")
  filePath    String   @map("file_path")
  fileSize    Int      @map("file_size")
  version     Int      @default(1)
  uploadedAt  DateTime @default(now()) @map("uploaded_at")

  founder User @relation(fields: [founderId], references: [id], onDelete: Cascade)

  @@map("pitch_materials")
}

model PortfolioCompany {
  id               String    @id @default(uuid())
  investorId       String    @map("investor_id")
  companyId        String    @map("company_id")
  investmentAmount Decimal?  @map("investment_amount") @db.Decimal(15, 2)
  investmentDate   DateTime? @map("investment_date")
  ownershipPercent Decimal?  @map("ownership_percent") @db.Decimal(5, 2)
  currentValuation Decimal?  @map("current_valuation") @db.Decimal(15, 2)
  status           String    @default("active")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  investor         User              @relation(fields: [investorId], references: [id], onDelete: Cascade)
  company          CompanyProfile    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  portfolioUpdates PortfolioUpdate[]
  sharedDocuments  SharedDocument[]

  @@unique([investorId, companyId])
  @@map("portfolio_companies")
}

model PortfolioUpdate {
  id         String   @id @default(uuid())
  investorId String   @map("investor_id")
  companyId  String   @map("company_id")
  title      String
  content    String
  createdAt  DateTime @default(now()) @map("created_at")

  investor User             @relation(fields: [investorId], references: [id], onDelete: Cascade)
  company  PortfolioCompany @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("portfolio_updates")
}

model SharedDocument {
  id         String   @id @default(uuid())
  investorId String   @map("investor_id")
  companyId  String   @map("company_id")
  fileName   String   @map("file_name")
  fileType   String   @map("file_type")
  fileSize   Int      @map("file_size")
  filePath   String   @map("file_path")
  sharedAt   DateTime @default(now()) @map("shared_at")

  investor User             @relation(fields: [investorId], references: [id], onDelete: Cascade)
  company  PortfolioCompany @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("shared_documents")
}

model Deal {
  id          String   @id @default(uuid())
  investorId  String   @map("investor_id")
  companyName String?  @map("company_name")
  valuation   Decimal? @db.Decimal(15, 2)
  amount      Decimal  @db.Decimal(15, 2)
  status      String?
  industry    String?
  stage       String?
  sector      String?
  createdAt   DateTime @default(now()) @map("created_at")

  investor          User               @relation(fields: [investorId], references: [id], onDelete: Cascade)
  dueDiligenceItems DueDiligenceItem[]
  dealInterests     DealInterest[]
  dealDocuments     DealDocument[]
  commitments       Commitment[]

  @@map("deals")
}

model DueDiligenceItem {
  id         String   @id @default(uuid())
  dealId     String   @map("deal_id")
  investorId String   @map("investor_id")
  itemName   String   @map("item_name")
  category   String?
  completed  Boolean  @default(false)
  notes      String?
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  deal     Deal @relation(fields: [dealId], references: [id], onDelete: Cascade)
  investor User @relation(fields: [investorId], references: [id], onDelete: Cascade)

  @@map("due_diligence_items")
}

model Spv {
  id              String   @id @default(uuid())
  name            String
  dealId          String   @map("deal_id")
  leadInvestorId  String   @map("lead_investor_id")
  targetAmount    Decimal  @map("target_amount") @db.Decimal(15, 2)
  carryPercentage Decimal  @map("carry_percentage") @db.Decimal(5, 2)
  description     String?
  status          String   @default("forming")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  leadInvestor User        @relation(fields: [leadInvestorId], references: [id], onDelete: Cascade)
  members      SpvMember[]

  @@map("spvs")
}

model SpvMember {
  id               String    @id @default(uuid())
  spvId            String    @map("spv_id")
  investorId       String    @map("investor_id")
  commitmentAmount Decimal   @map("commitment_amount") @db.Decimal(15, 2)
  status           String    @default("invited")
  joinedAt         DateTime? @map("joined_at")
  createdAt        DateTime  @default(now()) @map("created_at")

  spv      Spv  @relation(fields: [spvId], references: [id], onDelete: Cascade)
  investor User @relation(fields: [investorId], references: [id], onDelete: Cascade)

  @@unique([spvId, investorId])
  @@map("spv_members")
}

model DealInterest {
  id               String    @id @default(uuid())
  dealId           String    @map("deal_id")
  investorId       String    @map("investor_id")
  status           String    @default("pending")
  commitmentAmount Decimal   @map("commitment_amount") @db.Decimal(15, 2)
  notes            String?
  rejectionReason  String?   @map("rejection_reason")
  spvId            String?   @map("spv_id")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime? @updatedAt @map("updated_at")

  deal                  Deal                   @relation(fields: [dealId], references: [id], onDelete: Cascade)
  investor              User                   @relation(fields: [investorId], references: [id], onDelete: Cascade)
  investmentCommitments InvestmentCommitment[]

  @@map("deal_interests")
}

model DealDocument {
  id          String   @id @default(uuid())
  dealId      String   @map("deal_id")
  title       String
  description String?
  filePath    String   @map("file_path")
  fileType    String   @map("file_type")
  uploadedBy  String   @map("uploaded_by")
  createdAt   DateTime @default(now()) @map("created_at")

  deal     Deal @relation(fields: [dealId], references: [id], onDelete: Cascade)
  uploader User @relation(fields: [uploadedBy], references: [id], onDelete: Cascade)

  @@map("deal_documents")
}

model InvestmentCommitment {
  id               String    @id @default(uuid())
  interestId       String    @map("interest_id")
  investorId       String    @map("investor_id")
  spvId            String?   @map("spv_id")
  amount           Decimal   @db.Decimal(15, 2)
  status           String    @default("pending_payment")
  paymentReference String?   @map("payment_reference")
  wireInstructions String?   @map("wire_instructions")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime? @updatedAt @map("updated_at")

  interest DealInterest @relation(fields: [interestId], references: [id], onDelete: Cascade)
  investor User         @relation(fields: [investorId], references: [id], onDelete: Cascade)

  @@map("investment_commitments")
}

// ==================== COMPLIANCE MODELS ====================

model KYCDocument {
  id           String    @id @default(uuid())
  userId       String    @map("user_id")
  documentType String    @map("document_type")
  fileName     String    @map("file_name")
  fileUrl      String    @map("file_url")
  status       String    @default("pending")
  reviewNotes  String?   @map("review_notes")
  reviewedBy   String?   @map("reviewed_by")
  reviewedAt   DateTime? @map("reviewed_at")
  uploadedAt   DateTime  @default(now()) @map("uploaded_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("kyc_documents")
}

model AMLScreening {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  status      String    @default("pending")
  riskLevel   String?   @map("risk_level")
  screenedAt  DateTime  @default(now()) @map("screened_at")
  reviewNotes String?   @map("review_notes")
  reviewedBy  String?   @map("reviewed_by")
  reviewedAt  DateTime? @map("reviewed_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("aml_screenings")
}

model Accreditation {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  status      String    @default("pending")
  type        String?
  verifiedAt  DateTime? @map("verified_at")
  expiresAt   DateTime? @map("expires_at")
  documentUrl String?   @map("document_url")
  reviewNotes String?   @map("review_notes")
  reviewedBy  String?   @map("reviewed_by")
  createdAt   DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("accreditations")
}

// ==================== DOCUMENT MODELS ====================

model Document {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  title       String
  description String?
  fileUrl     String   @map("file_url")
  sharedWith  String?  @map("shared_with")
  createdAt   DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("documents")
}

// ==================== COMPANY MODEL (for founders) ====================

model Company {
  id          String   @id @default(uuid())
  founderId   String   @map("founder_id")
  name        String
  description String?
  website     String?
  sector      String?
  stage       String?
  teamSize    Int?     @map("team_size")
  location    String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  founder           User                  @relation("FounderCompany", fields: [founderId], references: [id], onDelete: Cascade)
  fundraisingRounds FundraisingRoundNew[]

  @@map("companies")
}

model FundraisingRoundNew {
  id           String   @id @default(uuid())
  companyId    String   @map("company_id")
  roundType    String   @map("round_type")
  targetAmount Decimal  @map("target_amount") @db.Decimal(15, 2)
  raisedAmount Decimal  @default(0) @map("raised_amount") @db.Decimal(15, 2)
  valuation    Decimal? @db.Decimal(15, 2)
  status       String   @default("active")
  createdAt    DateTime @default(now()) @map("created_at")

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("fundraising_rounds_new")
}

// ==================== COMMITMENT MODEL ====================

model Commitment {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  dealId    String   @map("deal_id")
  amount    Decimal  @db.Decimal(15, 2)
  notes     String?
  status    String   @default("pending")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  deal Deal @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@map("commitments")
}

// ==================== AUDIT LOG ====================

model AuditLog {
  id        String   @id @default(uuid())
  userId    String?  @map("user_id")
  action    String
  entity    String?
  entityId  String?  @map("entity_id")
  details   String?
  ipAddress String?  @map("ip_address")
  createdAt DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("audit_logs")
}

// ==================== PAYMENT SYSTEM ====================

enum PaymentGateway {
  RAZORPAY
  PAYU
  PAYTM
  CCAVENUE
  INSTAMOJO
  STRIPE
  PAYPAL
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

enum PaymentType {
  MEMBERSHIP_FEE
  DEAL_COMMITMENT
  EVENT_REGISTRATION
  SUBSCRIPTION
  OTHER
}

enum PaymentMethodType {
  CREDIT_CARD
  DEBIT_CARD
  NET_BANKING
  UPI
  WALLET
  INTERNATIONAL_CARD
  BANK_TRANSFER
}

model Payment {
  id                String         @id @default(uuid())
  userId            String         @map("user_id")
  amount            Decimal        @db.Decimal(15, 2)
  currency          String         @default("INR")
  gateway           PaymentGateway
  status            PaymentStatus  @default(PENDING)
  type              PaymentType
  gatewayOrderId    String?        @unique @map("gateway_order_id")
  gatewayPaymentId  String?        @unique @map("gateway_payment_id")
  gatewaySignature  String?        @map("gateway_signature")
  description       String?
  metadata          Json?
  failureReason     String?        @map("failure_reason")
  refundAmount      Decimal?       @db.Decimal(15, 2) @map("refund_amount")
  refundReason      String?        @map("refund_reason")
  refundedAt        DateTime?      @map("refunded_at")
  ipAddress         String?        @map("ip_address")
  userAgent         String?        @map("user_agent")
  encryptedData     String?        @map("encrypted_data") // Encrypted sensitive info
  createdAt         DateTime       @default(now()) @map("created_at")
  updatedAt         DateTime       @updatedAt @map("updated_at")
  completedAt       DateTime?      @map("completed_at")

  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  paymentMethod PaymentMethod? @relation(fields: [paymentMethodId], references: [id])
  paymentMethodId String?      @map("payment_method_id")

  @@index([userId])
  @@index([status])
  @@index([gateway])
  @@index([type])
  @@index([createdAt])
  @@map("payments")
}

model PaymentMethod {
  id                String            @id @default(uuid())
  userId            String            @map("user_id")
  type              PaymentMethodType
  isDefault         Boolean           @default(false) @map("is_default")
  lastFourDigits    String?           @map("last_four_digits") // Last 4 digits of card
  cardBrand         String?           @map("card_brand") // Visa, Mastercard, etc.
  expiryMonth       Int?              @map("expiry_month")
  expiryYear        Int?              @map("expiry_year")
  bankName          String?           @map("bank_name")
  upiId             String?           @map("upi_id")
  encryptedToken    String?           @map("encrypted_token") // Encrypted payment token
  gatewayCustomerId String?           @map("gateway_customer_id")
  gateway           PaymentGateway
  isActive          Boolean           @default(true) @map("is_active")
  metadata          Json?
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  payments Payment[]

  @@index([userId])
  @@index([gateway])
  @@map("payment_methods")
}

model PaymentWebhook {
  id            String         @id @default(uuid())
  gateway       PaymentGateway
  eventType     String         @map("event_type")
  eventId       String?        @unique @map("event_id")
  payload       Json
  signature     String?
  isVerified    Boolean        @default(false) @map("is_verified")
  isProcessed   Boolean        @default(false) @map("is_processed")
  processedAt   DateTime?      @map("processed_at")
  errorMessage  String?        @map("error_message")
  retryCount    Int            @default(0) @map("retry_count")
  ipAddress     String?        @map("ip_address")
  createdAt     DateTime       @default(now()) @map("created_at")

  @@index([gateway])
  @@index([eventType])
  @@index([isProcessed])
  @@index([createdAt])
  @@map("payment_webhooks")
}

model PaymentRefund {
  id               String    @id @default(uuid())
  paymentId        String    @map("payment_id")
  amount           Decimal   @db.Decimal(15, 2)
  reason           String
  status           String    @default("pending")
  gatewayRefundId  String?   @unique @map("gateway_refund_id")
  processedBy      String?   @map("processed_by")
  notes            String?
  createdAt        DateTime  @default(now()) @map("created_at")
  processedAt      DateTime? @map("processed_at")

  @@index([paymentId])
  @@index([status])
  @@map("payment_refunds")
}

// ==================== TAX & COMPLIANCE ====================

model TaxInformation {
  id            String   @id @default(uuid())
  userId        String   @unique @map("user_id")
  panNumber     String?  @unique @map("pan_number") // Indian PAN
  gstNumber     String?  @map("gst_number") // GST Number
  tanNumber     String?  @map("tan_number") // TAN for TDS
  taxCountry    String   @default("IN") @map("tax_country")
  taxIdType     String?  @map("tax_id_type") // SSN, TIN, etc. for international
  taxId         String?  @map("tax_id")
  isNRI         Boolean  @default(false) @map("is_nri")
  nriCountry    String?  @map("nri_country")
  tdsCertificate String? @map("tds_certificate") // Form 15CA/15CB for NRI
  form60Filed   Boolean  @default(false) @map("form60_filed") // If PAN not available
  form60Number  String?  @map("form60_number")
  encryptedData String?  @map("encrypted_data")
  verifiedAt    DateTime? @map("verified_at")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("tax_information")
}
