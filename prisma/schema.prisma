// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String   @map("password_hash")
  fullName     String?  @map("full_name")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  roles                  UserRole[]
  founderApplications    FounderApplication[]
  investorApplications   InvestorApplication[]
  eventRegistrations     EventRegistration[]
  eventWaitlist          EventWaitlist[]
  companyProfiles        CompanyProfile[]
  pitchSessions          PitchSession[]
  pitchMaterials         PitchMaterial[]
  portfolioCompanies     PortfolioCompany[]
  portfolioUpdates       PortfolioUpdate[]
  sharedDocuments        SharedDocument[]
  deals                  Deal[]
  dueDiligenceItems      DueDiligenceItem[]
  spvs                   Spv[]
  spvMemberships         SpvMember[]
  dealInterests          DealInterest[]
  dealDocuments          DealDocument[]
  investmentCommitments  InvestmentCommitment[]
  // New relations
  kycDocuments           KYCDocument[]
  amlScreenings          AMLScreening[]
  accreditations         Accreditation[]
  documents              Document[]
  companies              Company[]               @relation("FounderCompany")
  commitments            Commitment[]
  auditLogs              AuditLog[]
  payments               Payment[]
  paymentMethods         PaymentMethod[]
  emailLogs              EmailLog[]
  invoices               Invoice[]
  notificationPreference NotificationPreference?
  sentMessages           Message[]               @relation("SentMessages")
  threadsAsParticipant1  MessageThread[]         @relation("ThreadsAsParticipant1")
  threadsAsParticipant2  MessageThread[]         @relation("ThreadsAsParticipant2")
  activityLogs           ActivityLog[]
  // Phase 2 relations
  eventAttendance        EventAttendance[]
  certificates           Certificate[]
  financialStatements    FinancialStatement[]
  // Phase 3 relations - Membership
  memberships            UserMembership[]
  identityVerifications  IdentityVerification[]

  @@map("users")
}

model UserRole {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  role      String
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, role])
  @@map("user_roles")
}

model Event {
  id                   String    @id @default(uuid())
  title                String
  description          String?
  eventDate            DateTime  @map("event_date")
  location             String?
  capacity             Int?
  registrationDeadline DateTime? @map("registration_deadline")
  status               String    @default("upcoming")
  eventTypeId          String?   @map("event_type_id")
  createdAt            DateTime  @default(now()) @map("created_at")
  updatedAt            DateTime  @updatedAt @map("updated_at")

  // Enhanced fields for CMS
  city           String?
  venue          String?
  address        String?
  mapLatitude    Float?  @map("map_latitude")
  mapLongitude   Float?  @map("map_longitude")
  bannerImageUrl String? @map("banner_image_url")

  eventType     EventType?          @relation(fields: [eventTypeId], references: [id])
  registrations EventRegistration[]
  waitlist      EventWaitlist[]
  // Phase 2 relations
  attendance    EventAttendance[]
  certificates  Certificate[]
  // CMS relations
  eventStartups EventStartup[]

  @@index([eventTypeId])
  @@index([city])
  @@map("events")
}

model EventRegistration {
  id                  String   @id @default(uuid())
  eventId             String   @map("event_id")
  userId              String   @map("user_id")
  fullName            String   @map("full_name")
  email               String
  phone               String?
  company             String?
  dietaryRequirements String?  @map("dietary_requirements")
  status              String   @default("confirmed")
  notes               String?
  reminderSent        Boolean  @default(false) @map("reminder_sent")
  registeredAt        DateTime @default(now()) @map("registered_at")

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@map("event_registrations")
}

model EventWaitlist {
  id         String    @id @default(uuid())
  eventId    String    @map("event_id")
  userId     String    @map("user_id")
  fullName   String    @map("full_name")
  email      String
  phone      String?
  company    String?
  position   Int       @default(1)
  status     String    @default("waiting")
  notifiedAt DateTime? @map("notified_at")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId])
  @@map("event_waitlist")
}

model FounderApplication {
  id             String    @id @default(uuid())
  userId         String?   @map("user_id")
  fullName       String    @map("full_name")
  email          String
  phone          String?
  companyName    String    @map("company_name")
  companyWebsite String?   @map("company_website")
  industry       String?
  stage          String?
  description    String?
  fundingGoal    Decimal?  @map("funding_goal") @db.Decimal(15, 2)
  currentRevenue Decimal?  @map("current_revenue") @db.Decimal(15, 2)
  pitchDeckUrl   String?   @map("pitch_deck_url")
  status         String    @default("pending")
  reviewedAt     DateTime? @map("reviewed_at")
  reviewedBy     String?   @map("reviewed_by")
  reviewNotes    String?   @map("review_notes")
  submittedAt    DateTime  @default(now()) @map("submitted_at")
  metadata       Json?

  user           User?         @relation(fields: [userId], references: [id], onDelete: Cascade)
  industryDetail Industry?     @relation(fields: [industryId], references: [id])
  industryId     String?
  fundingStage   FundingStage? @relation(fields: [fundingStageId], references: [id])
  fundingStageId String?

  @@map("founder_applications")
}

model InvestorApplication {
  id                   String    @id @default(uuid())
  userId               String?   @map("user_id")
  fullName             String    @map("full_name")
  email                String
  phone                String?
  investorType         String    @map("investor_type")
  organization         String?
  investmentRange      String?   @map("investment_range")
  industriesOfInterest String?   @map("industries_of_interest")
  linkedinUrl          String?   @map("linkedin_url")
  accreditationStatus  String?   @map("accreditation_status")
  status               String    @default("pending")
  reviewedAt           DateTime? @map("reviewed_at")
  reviewedBy           String?   @map("reviewed_by")
  reviewNotes          String?   @map("review_notes")
  submittedAt          DateTime  @default(now()) @map("submitted_at")
  metadata             Json?

  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("investor_applications")
}

model CompanyProfile {
  id          String   @id @default(uuid())
  founderId   String   @map("founder_id")
  companyName String   @map("company_name")
  description String
  industry    String?
  stage       String?
  foundedYear Int?     @map("founded_year")
  teamSize    Int?     @map("team_size")
  website     String?
  linkedin    String?
  twitter     String?
  location    String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  founder            User               @relation(fields: [founderId], references: [id], onDelete: Cascade)
  fundraisingRounds  FundraisingRound[]
  portfolioCompanies PortfolioCompany[]
  industryDetail     Industry?          @relation(fields: [industryId], references: [id])
  industryId         String?
  fundingStage       FundingStage?      @relation(fields: [fundingStageId], references: [id])
  fundingStageId     String?

  @@unique([founderId])
  @@map("company_profiles")
}

model FundraisingRound {
  id              String    @id @default(uuid())
  companyId       String    @map("company_id")
  roundName       String    @map("round_name")
  targetAmount    Decimal   @map("target_amount") @db.Decimal(15, 2)
  raisedAmount    Decimal   @default(0) @map("raised_amount") @db.Decimal(15, 2)
  status          String    @default("planning")
  startDate       DateTime? @map("start_date")
  targetCloseDate DateTime? @map("target_close_date")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  company CompanyProfile @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("fundraising_rounds")
}

model PitchSession {
  id          String   @id @default(uuid())
  founderId   String   @map("founder_id")
  investorId  String?  @map("investor_id")
  sessionDate DateTime @map("session_date")
  duration    Int      @default(30)
  location    String?
  meetingLink String?  @map("meeting_link")
  status      String   @default("scheduled")
  notes       String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  founder User @relation(fields: [founderId], references: [id], onDelete: Cascade)

  @@map("pitch_sessions")
}

model PitchMaterial {
  id          String   @id @default(uuid())
  founderId   String   @map("founder_id")
  title       String
  description String?
  fileType    String   @map("file_type")
  filePath    String   @map("file_path")
  fileSize    Int      @map("file_size")
  version     Int      @default(1)
  uploadedAt  DateTime @default(now()) @map("uploaded_at")

  founder User @relation(fields: [founderId], references: [id], onDelete: Cascade)

  @@map("pitch_materials")
}

model PortfolioCompany {
  id               String    @id @default(uuid())
  investorId       String    @map("investor_id")
  companyId        String    @map("company_id")
  investmentAmount Decimal?  @map("investment_amount") @db.Decimal(15, 2)
  investmentDate   DateTime? @map("investment_date")
  ownershipPercent Decimal?  @map("ownership_percent") @db.Decimal(5, 2)
  currentValuation Decimal?  @map("current_valuation") @db.Decimal(15, 2)
  status           String    @default("active")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")

  investor         User              @relation(fields: [investorId], references: [id], onDelete: Cascade)
  company          CompanyProfile    @relation(fields: [companyId], references: [id], onDelete: Cascade)
  portfolioUpdates PortfolioUpdate[]
  sharedDocuments  SharedDocument[]

  @@unique([investorId, companyId])
  @@map("portfolio_companies")
}

model PortfolioUpdate {
  id         String   @id @default(uuid())
  investorId String   @map("investor_id")
  companyId  String   @map("company_id")
  title      String
  content    String
  createdAt  DateTime @default(now()) @map("created_at")

  investor User             @relation(fields: [investorId], references: [id], onDelete: Cascade)
  company  PortfolioCompany @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("portfolio_updates")
}

model SharedDocument {
  id         String   @id @default(uuid())
  investorId String   @map("investor_id")
  companyId  String   @map("company_id")
  fileName   String   @map("file_name")
  fileType   String   @map("file_type")
  fileSize   Int      @map("file_size")
  filePath   String   @map("file_path")
  sharedAt   DateTime @default(now()) @map("shared_at")

  investor User             @relation(fields: [investorId], references: [id], onDelete: Cascade)
  company  PortfolioCompany @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("shared_documents")
}

model Deal {
  id          String   @id @default(uuid())
  investorId  String   @map("investor_id")
  companyName String?  @map("company_name")
  valuation   Decimal? @db.Decimal(15, 2)
  amount      Decimal  @db.Decimal(15, 2)
  status      String?
  industry    String?
  stage       String?
  sector      String?
  createdAt   DateTime @default(now()) @map("created_at")

  investor          User               @relation(fields: [investorId], references: [id], onDelete: Cascade)
  dueDiligenceItems DueDiligenceItem[]
  dealInterests     DealInterest[]
  dealDocuments     DealDocument[]
  commitments       Commitment[]
  industryDetail    Industry?          @relation(fields: [industryId], references: [id])
  industryId        String?
  fundingStage      FundingStage?      @relation(fields: [fundingStageId], references: [id])
  fundingStageId    String?

  @@map("deals")
}

model DueDiligenceItem {
  id         String   @id @default(uuid())
  dealId     String   @map("deal_id")
  investorId String   @map("investor_id")
  itemName   String   @map("item_name")
  category   String?
  completed  Boolean  @default(false)
  notes      String?
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  deal     Deal @relation(fields: [dealId], references: [id], onDelete: Cascade)
  investor User @relation(fields: [investorId], references: [id], onDelete: Cascade)

  @@map("due_diligence_items")
}

model Spv {
  id              String   @id @default(uuid())
  name            String
  dealId          String   @map("deal_id")
  leadInvestorId  String   @map("lead_investor_id")
  targetAmount    Decimal  @map("target_amount") @db.Decimal(15, 2)
  carryPercentage Decimal  @map("carry_percentage") @db.Decimal(5, 2)
  description     String?
  status          String   @default("forming")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  leadInvestor User        @relation(fields: [leadInvestorId], references: [id], onDelete: Cascade)
  members      SpvMember[]

  @@map("spvs")
}

model SpvMember {
  id               String    @id @default(uuid())
  spvId            String    @map("spv_id")
  investorId       String    @map("investor_id")
  commitmentAmount Decimal   @map("commitment_amount") @db.Decimal(15, 2)
  status           String    @default("invited")
  joinedAt         DateTime? @map("joined_at")
  createdAt        DateTime  @default(now()) @map("created_at")

  spv      Spv  @relation(fields: [spvId], references: [id], onDelete: Cascade)
  investor User @relation(fields: [investorId], references: [id], onDelete: Cascade)

  @@unique([spvId, investorId])
  @@map("spv_members")
}

model DealInterest {
  id               String    @id @default(uuid())
  dealId           String    @map("deal_id")
  investorId       String    @map("investor_id")
  status           String    @default("pending")
  commitmentAmount Decimal   @map("commitment_amount") @db.Decimal(15, 2)
  notes            String?
  rejectionReason  String?   @map("rejection_reason")
  spvId            String?   @map("spv_id")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime? @updatedAt @map("updated_at")

  deal                  Deal                   @relation(fields: [dealId], references: [id], onDelete: Cascade)
  investor              User                   @relation(fields: [investorId], references: [id], onDelete: Cascade)
  investmentCommitments InvestmentCommitment[]

  @@map("deal_interests")
}

model DealDocument {
  id          String   @id @default(uuid())
  dealId      String   @map("deal_id")
  title       String
  description String?
  filePath    String   @map("file_path")
  fileType    String   @map("file_type")
  uploadedBy  String   @map("uploaded_by")
  createdAt   DateTime @default(now()) @map("created_at")

  deal     Deal @relation(fields: [dealId], references: [id], onDelete: Cascade)
  uploader User @relation(fields: [uploadedBy], references: [id], onDelete: Cascade)

  @@map("deal_documents")
}

model InvestmentCommitment {
  id               String    @id @default(uuid())
  interestId       String    @map("interest_id")
  investorId       String    @map("investor_id")
  spvId            String?   @map("spv_id")
  amount           Decimal   @db.Decimal(15, 2)
  status           String    @default("pending_payment")
  paymentReference String?   @map("payment_reference")
  wireInstructions String?   @map("wire_instructions")
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime? @updatedAt @map("updated_at")

  interest DealInterest @relation(fields: [interestId], references: [id], onDelete: Cascade)
  investor User         @relation(fields: [investorId], references: [id], onDelete: Cascade)

  @@map("investment_commitments")
}

// ==================== COMPLIANCE MODELS ====================

model KYCDocument {
  id           String    @id @default(uuid())
  userId       String    @map("user_id")
  documentType String    @map("document_type")
  fileName     String    @map("file_name")
  fileUrl      String    @map("file_url")
  status       String    @default("pending")
  reviewNotes  String?   @map("review_notes")
  reviewedBy   String?   @map("reviewed_by")
  reviewedAt   DateTime? @map("reviewed_at")
  uploadedAt   DateTime  @default(now()) @map("uploaded_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("kyc_documents")
}

model AMLScreening {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  status      String    @default("pending")
  riskLevel   String?   @map("risk_level")
  screenedAt  DateTime  @default(now()) @map("screened_at")
  reviewNotes String?   @map("review_notes")
  reviewedBy  String?   @map("reviewed_by")
  reviewedAt  DateTime? @map("reviewed_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("aml_screenings")
}

model Accreditation {
  id          String    @id @default(uuid())
  userId      String    @map("user_id")
  status      String    @default("pending")
  type        String?
  verifiedAt  DateTime? @map("verified_at")
  expiresAt   DateTime? @map("expires_at")
  documentUrl String?   @map("document_url")
  reviewNotes String?   @map("review_notes")
  reviewedBy  String?   @map("reviewed_by")
  createdAt   DateTime  @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("accreditations")
}

// ==================== DOCUMENT MODELS ====================

model Document {
  id          String   @id @default(uuid())
  userId      String   @map("user_id")
  title       String
  description String?
  fileUrl     String   @map("file_url")
  sharedWith  String?  @map("shared_with")
  createdAt   DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("documents")
}

// ==================== COMPANY MODEL (for founders) ====================

model Company {
  id          String   @id @default(uuid())
  founderId   String   @map("founder_id")
  name        String
  description String?
  website     String?
  sector      String?
  stage       String?
  teamSize    Int?     @map("team_size")
  location    String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  founder           User                  @relation("FounderCompany", fields: [founderId], references: [id], onDelete: Cascade)
  fundraisingRounds FundraisingRoundNew[]

  @@map("companies")
}

model FundraisingRoundNew {
  id           String   @id @default(uuid())
  companyId    String   @map("company_id")
  roundType    String   @map("round_type")
  targetAmount Decimal  @map("target_amount") @db.Decimal(15, 2)
  raisedAmount Decimal  @default(0) @map("raised_amount") @db.Decimal(15, 2)
  valuation    Decimal? @db.Decimal(15, 2)
  status       String   @default("active")
  createdAt    DateTime @default(now()) @map("created_at")

  company Company @relation(fields: [companyId], references: [id], onDelete: Cascade)

  @@map("fundraising_rounds_new")
}

// ==================== COMMITMENT MODEL ====================

model Commitment {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  dealId    String   @map("deal_id")
  amount    Decimal  @db.Decimal(15, 2)
  notes     String?
  status    String   @default("pending")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  deal Deal @relation(fields: [dealId], references: [id], onDelete: Cascade)

  @@map("commitments")
}

// ==================== AUDIT LOG ====================

model AuditLog {
  id        String   @id @default(uuid())
  userId    String?  @map("user_id")
  action    String
  entity    String?
  entityId  String?  @map("entity_id")
  details   String?
  ipAddress String?  @map("ip_address")
  createdAt DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("audit_logs")
}

// ==================== PAYMENT SYSTEM ====================

enum PaymentGateway {
  RAZORPAY
  PAYU
  PAYTM
  CCAVENUE
  INSTAMOJO
  STRIPE
  PAYPAL
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

enum PaymentType {
  MEMBERSHIP_FEE
  DEAL_COMMITMENT
  EVENT_REGISTRATION
  SUBSCRIPTION
  OTHER
}

enum PaymentMethodType {
  CREDIT_CARD
  DEBIT_CARD
  NET_BANKING
  UPI
  WALLET
  INTERNATIONAL_CARD
  BANK_TRANSFER
}

model Payment {
  id               String         @id @default(uuid())
  userId           String         @map("user_id")
  amount           Decimal        @db.Decimal(15, 2)
  currency         String         @default("INR")
  gateway          PaymentGateway
  status           PaymentStatus  @default(PENDING)
  type             PaymentType
  gatewayOrderId   String?        @unique @map("gateway_order_id")
  gatewayPaymentId String?        @unique @map("gateway_payment_id")
  gatewaySignature String?        @map("gateway_signature")
  description      String?
  metadata         Json?
  failureReason    String?        @map("failure_reason")
  refundAmount     Decimal?       @map("refund_amount") @db.Decimal(15, 2)
  refundReason     String?        @map("refund_reason")
  refundedAt       DateTime?      @map("refunded_at")
  ipAddress        String?        @map("ip_address")
  userAgent        String?        @map("user_agent")
  encryptedData    String?        @map("encrypted_data") // Encrypted sensitive info
  createdAt        DateTime       @default(now()) @map("created_at")
  updatedAt        DateTime       @updatedAt @map("updated_at")
  completedAt      DateTime?      @map("completed_at")

  user            User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  paymentMethod   PaymentMethod? @relation(fields: [paymentMethodId], references: [id])
  paymentMethodId String?        @map("payment_method_id")
  invoice         Invoice?

  @@index([userId])
  @@index([status])
  @@index([gateway])
  @@index([type])
  @@index([createdAt])
  @@index([userId, createdAt])
  @@map("payments")
}

model PaymentMethod {
  id                String            @id @default(uuid())
  userId            String            @map("user_id")
  type              PaymentMethodType
  isDefault         Boolean           @default(false) @map("is_default")
  lastFourDigits    String?           @map("last_four_digits") // Last 4 digits of card
  cardBrand         String?           @map("card_brand") // Visa, Mastercard, etc.
  expiryMonth       Int?              @map("expiry_month")
  expiryYear        Int?              @map("expiry_year")
  bankName          String?           @map("bank_name")
  upiId             String?           @map("upi_id")
  encryptedToken    String?           @map("encrypted_token") // Encrypted payment token
  gatewayCustomerId String?           @map("gateway_customer_id")
  gateway           PaymentGateway
  isActive          Boolean           @default(true) @map("is_active")
  metadata          Json?
  createdAt         DateTime          @default(now()) @map("created_at")
  updatedAt         DateTime          @updatedAt @map("updated_at")

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  payments Payment[]

  @@index([userId])
  @@index([gateway])
  @@map("payment_methods")
}

model PaymentWebhook {
  id           String         @id @default(uuid())
  gateway      PaymentGateway
  eventType    String         @map("event_type")
  eventId      String?        @unique @map("event_id")
  payload      Json
  signature    String?
  isVerified   Boolean        @default(false) @map("is_verified")
  isProcessed  Boolean        @default(false) @map("is_processed")
  processedAt  DateTime?      @map("processed_at")
  errorMessage String?        @map("error_message")
  retryCount   Int            @default(0) @map("retry_count")
  ipAddress    String?        @map("ip_address")
  createdAt    DateTime       @default(now()) @map("created_at")

  @@index([gateway])
  @@index([eventType])
  @@index([isProcessed])
  @@index([createdAt])
  @@map("payment_webhooks")
}

model PaymentRefund {
  id              String    @id @default(uuid())
  paymentId       String    @map("payment_id")
  amount          Decimal   @db.Decimal(15, 2)
  reason          String
  status          String    @default("pending")
  gatewayRefundId String?   @unique @map("gateway_refund_id")
  processedBy     String?   @map("processed_by")
  notes           String?
  createdAt       DateTime  @default(now()) @map("created_at")
  processedAt     DateTime? @map("processed_at")

  @@index([paymentId])
  @@index([status])
  @@map("payment_refunds")
}

// ==================== TAX & COMPLIANCE ====================

model TaxInformation {
  id             String    @id @default(uuid())
  userId         String    @unique @map("user_id")
  panNumber      String?   @unique @map("pan_number") // Indian PAN
  gstNumber      String?   @map("gst_number") // GST Number
  tanNumber      String?   @map("tan_number") // TAN for TDS
  taxCountry     String    @default("IN") @map("tax_country")
  taxIdType      String?   @map("tax_id_type") // SSN, TIN, etc. for international
  taxId          String?   @map("tax_id")
  isNRI          Boolean   @default(false) @map("is_nri")
  nriCountry     String?   @map("nri_country")
  tdsCertificate String?   @map("tds_certificate") // Form 15CA/15CB for NRI
  form60Filed    Boolean   @default(false) @map("form60_filed") // If PAN not available
  form60Number   String?   @map("form60_number")
  encryptedData  String?   @map("encrypted_data")
  verifiedAt     DateTime? @map("verified_at")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  @@map("tax_information")
}

// ==================== REFERENCE DATA (SEED DATA SINGLE SOURCE OF TRUTH) ====================

model Industry {
  id           String   @id @default(cuid())
  name         String   @unique
  code         String   @unique
  description  String?
  icon         String?
  displayOrder Int      @default(0) @map("display_order")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  founderApplications FounderApplication[]
  companyProfiles     CompanyProfile[]
  deals               Deal[]

  @@index([isActive, displayOrder])
  @@map("industries")
}

model FundingStage {
  id           String   @id @default(cuid())
  name         String   @unique
  code         String   @unique
  description  String?
  typicalMin   Decimal? @map("typical_min") @db.Decimal(15, 2)
  typicalMax   Decimal? @map("typical_max") @db.Decimal(15, 2)
  displayOrder Int      @default(0) @map("display_order")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  founderApplications FounderApplication[]
  companyProfiles     CompanyProfile[]
  deals               Deal[]

  @@index([isActive, displayOrder])
  @@map("funding_stages")
}

model EventType {
  id          String   @id @default(cuid())
  name        String   @unique
  code        String   @unique
  description String?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  events Event[]

  @@index([isActive])
  @@map("event_types")
}

// ==================== EMAIL & NOTIFICATIONS ====================

model EmailTemplate {
  id        String   @id @default(cuid())
  name      String   @unique
  subject   String
  htmlBody  String   @map("html_body") @db.Text
  textBody  String?  @map("text_body") @db.Text
  variables Json?
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("email_templates")
}

model EmailLog {
  id           String      @id @default(cuid())
  userId       String?     @map("user_id")
  to           String
  subject      String
  templateName String?     @map("template_name")
  status       EmailStatus
  provider     String      @default("emailit")
  providerId   String?     @map("provider_id")
  error        String?
  sentAt       DateTime    @default(now()) @map("sent_at")
  openedAt     DateTime?   @map("opened_at")
  clickedAt    DateTime?   @map("clicked_at")

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([status])
  @@index([sentAt])
  @@map("email_logs")
}

enum EmailStatus {
  PENDING
  SENT
  DELIVERED
  OPENED
  CLICKED
  FAILED
  BOUNCED
}

model NotificationPreference {
  id                String                @id @default(cuid())
  userId            String                @unique @map("user_id")
  emailPayments     Boolean               @default(true) @map("email_payments")
  emailMessages     Boolean               @default(true) @map("email_messages")
  emailEvents       Boolean               @default(true) @map("email_events")
  emailApplications Boolean               @default(true) @map("email_applications")
  emailDeals        Boolean               @default(true) @map("email_deals")
  emailMarketing    Boolean               @default(false) @map("email_marketing")
  inAppMessages     Boolean               @default(true) @map("inapp_messages")
  inAppEvents       Boolean               @default(true) @map("inapp_events")
  inAppPayments     Boolean               @default(true) @map("inapp_payments")
  inAppApplications Boolean               @default(true) @map("inapp_applications")
  emailFrequency    NotificationFrequency @default(IMMEDIATE) @map("email_frequency")
  createdAt         DateTime              @default(now()) @map("created_at")
  updatedAt         DateTime              @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("notification_preferences")
}

enum NotificationFrequency {
  IMMEDIATE
  DAILY_DIGEST
  WEEKLY_DIGEST
  NONE
}

// ==================== INVOICES ====================

model Invoice {
  id             String        @id @default(cuid())
  invoiceNumber  String        @unique @map("invoice_number")
  userId         String        @map("user_id")
  paymentId      String        @unique @map("payment_id")
  issueDate      DateTime      @default(now()) @map("issue_date")
  dueDate        DateTime?     @map("due_date")
  buyerName      String        @map("buyer_name")
  buyerEmail     String        @map("buyer_email")
  buyerPhone     String?       @map("buyer_phone")
  buyerPAN       String?       @map("buyer_pan")
  buyerAddress   String?       @map("buyer_address")
  sellerName     String        @default("India Angel Forum") @map("seller_name")
  sellerGST      String?       @map("seller_gst")
  sellerPAN      String?       @map("seller_pan")
  sellerAddress  String?       @map("seller_address")
  lineItems      Json          @map("line_items")
  subtotal       Decimal       @db.Decimal(15, 2)
  cgst           Decimal       @default(0) @db.Decimal(15, 2)
  sgst           Decimal       @default(0) @db.Decimal(15, 2)
  igst           Decimal       @default(0) @db.Decimal(15, 2)
  tds            Decimal       @default(0) @db.Decimal(15, 2)
  totalAmount    Decimal       @map("total_amount") @db.Decimal(15, 2)
  pdfPath        String?       @map("pdf_path")
  pdfGeneratedAt DateTime?     @map("pdf_generated_at")
  status         InvoiceStatus @default(DRAFT)
  notes          String?
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  payment Payment @relation(fields: [paymentId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([issueDate])
  @@map("invoices")
}

enum InvoiceStatus {
  DRAFT
  ISSUED
  PAID
  CANCELLED
  REFUNDED
}

// ==================== MESSAGING ====================

model Message {
  id          String    @id @default(cuid())
  threadId    String    @map("thread_id")
  senderId    String    @map("sender_id")
  content     String    @db.Text
  attachments Json?
  isRead      Boolean   @default(false) @map("is_read")
  readAt      DateTime? @map("read_at")
  isEdited    Boolean   @default(false) @map("is_edited")
  editedAt    DateTime? @map("edited_at")
  isDeleted   Boolean   @default(false) @map("is_deleted")
  deletedAt   DateTime? @map("deleted_at")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  thread MessageThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  sender User          @relation("SentMessages", fields: [senderId], references: [id])

  @@index([threadId, createdAt])
  @@index([senderId])
  @@map("messages")
}

model MessageThread {
  id                 String    @id @default(cuid())
  subject            String?
  participant1Id     String    @map("participant1_id")
  participant2Id     String    @map("participant2_id")
  isBlocked          Boolean   @default(false) @map("is_blocked")
  blockedBy          String?   @map("blocked_by")
  blockedAt          DateTime? @map("blocked_at")
  lastMessageAt      DateTime  @default(now()) @map("last_message_at")
  lastMessagePreview String?   @map("last_message_preview")
  unreadCountP1      Int       @default(0) @map("unread_count_p1")
  unreadCountP2      Int       @default(0) @map("unread_count_p2")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  participant1 User      @relation("ThreadsAsParticipant1", fields: [participant1Id], references: [id])
  participant2 User      @relation("ThreadsAsParticipant2", fields: [participant2Id], references: [id])
  messages     Message[]

  @@unique([participant1Id, participant2Id])
  @@index([participant1Id, lastMessageAt])
  @@index([participant2Id, lastMessageAt])
  @@map("message_threads")
}

// ==================== ACTIVITY LOGS ====================

model ActivityLog {
  id           String       @id @default(cuid())
  userId       String       @map("user_id")
  activityType ActivityType @map("activity_type")
  entityType   String       @map("entity_type")
  entityId     String       @map("entity_id")
  description  String
  metadata     Json?
  createdAt    DateTime     @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, createdAt])
  @@index([activityType, createdAt])
  @@index([createdAt])
  @@map("activity_logs")
}

enum ActivityType {
  PAYMENT_CREATED
  PAYMENT_COMPLETED
  PAYMENT_FAILED
  PAYMENT_REFUNDED
  EVENT_REGISTERED
  EVENT_ATTENDED
  EVENT_CANCELLED
  APPLICATION_SUBMITTED
  APPLICATION_APPROVED
  APPLICATION_REJECTED
  DEAL_INTEREST_EXPRESSED
  DEAL_COMMITTED
  MESSAGE_SENT
  MESSAGE_RECEIVED
  DOCUMENT_UPLOADED
  DOCUMENT_SHARED
  CERTIFICATE_ISSUED
  STATEMENT_GENERATED
  PROFILE_UPDATED
  MEMBERSHIP_ACTIVATED
  MEMBERSHIP_RENEWED
  MEMBERSHIP_CANCELLED
  MEMBERSHIP_PLAN_CHANGED
  IDENTITY_VERIFIED
}

// ==================== EVENT ATTENDANCE ====================

model EventAttendance {
  id               String            @id @default(cuid())
  userId           String            @map("user_id")
  eventId          String            @map("event_id")
  rsvpStatus       RsvpStatus        @default(CONFIRMED) @map("rsvp_status")
  attendanceStatus AttendanceStatus? @map("attendance_status")
  checkInTime      DateTime?         @map("check_in_time")
  checkOutTime     DateTime?         @map("check_out_time")
  certificateId    String?           @unique @map("certificate_id")
  certificateUrl   String?           @map("certificate_url")
  notes            String?
  createdAt        DateTime          @default(now()) @map("created_at")
  updatedAt        DateTime          @updatedAt @map("updated_at")

  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  event       Event        @relation(fields: [eventId], references: [id], onDelete: Cascade)
  certificate Certificate?

  @@unique([userId, eventId])
  @@index([userId])
  @@index([eventId])
  @@index([rsvpStatus])
  @@index([attendanceStatus])
  @@map("event_attendance")
}

enum RsvpStatus {
  CONFIRMED
  WAITLIST
  CANCELLED
  NO_SHOW
}

enum AttendanceStatus {
  ATTENDED
  PARTIAL
  ABSENT
}

// ==================== CERTIFICATES ====================

model Certificate {
  id              String   @id @default(cuid())
  certificateId   String   @unique @map("certificate_id") // CERT-2026-001234
  userId          String   @map("user_id")
  eventId         String   @map("event_id")
  attendeeName    String   @map("attendee_name")
  eventName       String   @map("event_name")
  eventDate       DateTime @map("event_date")
  duration        Int // minutes
  pdfUrl          String   @map("pdf_url")
  verificationUrl String   @map("verification_url")
  issuedAt        DateTime @default(now()) @map("issued_at")

  user       User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  event      Event            @relation(fields: [eventId], references: [id], onDelete: Cascade)
  attendance EventAttendance? @relation(fields: [certificateId], references: [certificateId])

  @@index([userId])
  @@index([eventId])
  @@index([certificateId])
  @@map("certificates")
}

// ==================== CMS MODELS ====================

model TeamMember {
  id           String   @id @default(uuid())
  name         String
  role         String
  bio          String?
  photoUrl     String?  @map("photo_url")
  linkedinUrl  String?  @map("linkedin_url")
  displayOrder Int      @default(0) @map("display_order")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@map("team_members")
}

model Partner {
  id           String   @id @default(uuid())
  name         String
  logoUrl      String?  @map("logo_url")
  websiteUrl   String?  @map("website_url")
  description  String?
  displayOrder Int      @default(0) @map("display_order")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@map("partners")
}

model EventStartup {
  id               String   @id @default(uuid())
  eventId          String   @map("event_id")
  companyName      String   @map("company_name")
  companyLogoUrl   String?  @map("company_logo_url")
  founderName      String   @map("founder_name")
  founderPhotoUrl  String?  @map("founder_photo_url")
  founderLinkedin  String?  @map("founder_linkedin")
  pitchDescription String?  @map("pitch_description")
  industry         String?
  fundingStage     String?  @map("funding_stage")
  displayOrder     Int      @default(0) @map("display_order")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@map("event_startups")
}

// ==================== FINANCIAL STATEMENTS ====================

model FinancialStatement {
  id              String    @id @default(cuid())
  statementNumber String    @unique @map("statement_number") // FS-2026-02-00001
  userId          String    @map("user_id")
  dateFrom        DateTime  @map("date_from")
  dateTo          DateTime  @map("date_to")
  month           Int // 1-12
  year            Int // 2024, 2025, etc.
  totalInvested   Decimal   @default(0) @map("total_invested") @db.Decimal(15, 2)
  totalRefunded   Decimal   @default(0) @map("total_refunded") @db.Decimal(15, 2)
  netInvestment   Decimal   @default(0) @map("net_investment") @db.Decimal(15, 2)
  totalTax        Decimal   @default(0) @map("total_tax") @db.Decimal(15, 2)
  cgst            Decimal   @default(0) @db.Decimal(15, 2) // 9% CGST
  sgst            Decimal   @default(0) @db.Decimal(15, 2) // 9% SGST
  igst            Decimal   @default(0) @db.Decimal(15, 2) // 18% IGST
  tds             Decimal   @default(0) @db.Decimal(15, 2) // 1% TDS
  format          String    @default("detailed") // detailed | summary
  pdfUrl          String    @map("pdf_url")
  emailedTo       String[]  @default([]) @map("emailed_to")
  emailedAt       DateTime? @map("emailed_at") // When last emailed
  generatedAt     DateTime  @default(now()) @map("generated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([dateFrom])
  @@index([dateTo])
  @@index([month])
  @@index([year])
  @@index([generatedAt])
  @@map("financial_statements")
}

// ==================== MEMBERSHIP SYSTEM ====================

enum BillingCycle {
  MONTHLY
  ANNUAL
}

enum MembershipStatus {
  ACTIVE
  EXPIRED
  CANCELLED
  SUSPENDED
}

enum MembershipChangeType {
  ACTIVATION
  RENEWAL
  UPGRADE
  DOWNGRADE
  CANCELLATION
  PRICE_CHANGE
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
}

enum VerificationStatus {
  PENDING
  COMPLETED
  FAILED
  EXPIRED
}

model MembershipPlan {
  id           String       @id @default(cuid())
  name         String
  slug         String       @unique
  description  String?
  price        Decimal      @db.Decimal(15, 2)
  currency     String       @default("INR")
  billingCycle BillingCycle @default(ANNUAL) @map("billing_cycle")
  features     Json? // Array of feature strings
  isActive     Boolean      @default(true) @map("is_active")
  displayOrder Int          @default(0) @map("display_order")
  createdAt    DateTime     @default(now()) @map("created_at")
  updatedAt    DateTime     @updatedAt @map("updated_at")

  memberships UserMembership[]
  changeLogs  MembershipPlanChangeLog[] @relation("NewPlanChanges")
  oldPlanLogs MembershipPlanChangeLog[] @relation("OldPlanChanges")

  @@index([isActive, displayOrder])
  @@map("membership_plans")
}

model UserMembership {
  id             String           @id @default(cuid())
  userId         String           @map("user_id")
  planId         String           @map("plan_id")
  status         MembershipStatus @default(ACTIVE)
  startDate      DateTime         @map("start_date")
  endDate        DateTime         @map("end_date")
  paymentId      String?          @map("payment_id")
  discountCodeId String?          @map("discount_code_id")
  proratedAmount Decimal?         @map("prorated_amount") @db.Decimal(15, 2)
  autoRenew      Boolean          @default(false) @map("auto_renew")
  createdAt      DateTime         @default(now()) @map("created_at")
  updatedAt      DateTime         @updatedAt @map("updated_at")

  user         User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan         MembershipPlan @relation(fields: [planId], references: [id])
  discountCode DiscountCode?  @relation(fields: [discountCodeId], references: [id])

  @@index([userId])
  @@index([status])
  @@index([endDate])
  @@map("user_memberships")
}

model MembershipPlanChangeLog {
  id             String               @id @default(cuid())
  userId         String               @map("user_id")
  oldPlanId      String?              @map("old_plan_id")
  newPlanId      String?              @map("new_plan_id")
  changeType     MembershipChangeType @map("change_type")
  oldPrice       Decimal?             @map("old_price") @db.Decimal(15, 2)
  newPrice       Decimal?             @map("new_price") @db.Decimal(15, 2)
  proratedAmount Decimal?             @map("prorated_amount") @db.Decimal(15, 2)
  reason         String?
  changedBy      String               @map("changed_by")
  metadata       Json?
  createdAt      DateTime             @default(now()) @map("created_at")

  oldPlan MembershipPlan? @relation("OldPlanChanges", fields: [oldPlanId], references: [id])
  newPlan MembershipPlan? @relation("NewPlanChanges", fields: [newPlanId], references: [id])

  @@index([userId, createdAt])
  @@index([changeType])
  @@map("membership_plan_change_log")
}

model DiscountCode {
  id                String       @id @default(cuid())
  code              String       @unique
  description       String?
  discountType      DiscountType @map("discount_type")
  discountValue     Decimal      @map("discount_value") @db.Decimal(15, 2)
  maxUses           Int?         @map("max_uses")
  currentUses       Int          @default(0) @map("current_uses")
  validFrom         DateTime     @map("valid_from")
  validUntil        DateTime?    @map("valid_until")
  applicablePlanIds String[]     @default([]) @map("applicable_plan_ids")
  minPurchaseAmount Decimal?     @map("min_purchase_amount") @db.Decimal(15, 2)
  isActive          Boolean      @default(true) @map("is_active")
  createdBy         String       @map("created_by")
  createdAt         DateTime     @default(now()) @map("created_at")
  updatedAt         DateTime     @updatedAt @map("updated_at")

  memberships UserMembership[]

  @@index([code])
  @@index([isActive])
  @@map("discount_codes")
}

model IdentityVerification {
  id                String             @id @default(cuid())
  userId            String             @map("user_id")
  provider          String             @default("persona")
  providerInquiryId String?            @map("provider_inquiry_id")
  status            VerificationStatus @default(PENDING)
  verifiedAt        DateTime?          @map("verified_at")
  expiresAt         DateTime?          @map("expires_at")
  metadata          Json?
  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@map("identity_verifications")
}

model SystemConfig {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  description String?
  updatedBy   String?  @map("updated_by")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@map("system_config")
}
